# CMS Core Services Stack
# This stack contains the essential backend services required for CMS operation
# Deploy this stack first before any other stacks

services:
  # PostgreSQL Database
  database:
    image: postgres:15
    container_name: cms-database
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-cmsdb}
      POSTGRES_USER: ${POSTGRES_USER:-cmsuser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-cmspassword}
      POSTGRES_HOST_AUTH_METHOD: ${POSTGRES_HOST_AUTH_METHOD:-md5}
    ports:
      - "127.0.0.1:${POSTGRES_PORT_EXTERNAL:-5432}:5432"
    volumes:
      - cms-database-data:/var/lib/postgresql/data
    networks:
      - cms-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-cmsuser} -d ${POSTGRES_DB:-cmsdb}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # CMS Log Service - Centralized logging
  log-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APT_MIRROR: ${APT_MIRROR:-archive.ubuntu.com}
    container_name: cms-log-service
    restart: unless-stopped
    depends_on:
      database:
        condition: service_healthy
    environment:
      CMS_CONFIG: ${CMS_CONFIG:-/usr/local/etc/cms.toml}
      SERVICE_TYPE: LogService
      SERVICE_SHARD: ${LOG_SERVICE_SHARD:-0}
    ports:
      - "${TAILSCALE_IP:-127.0.0.1}:29000:29000"
    volumes:
      - ./config/cms.toml:/usr/local/etc/cms.toml:ro
      - cms-logs:/var/local/log/cms
      - cms-cache:/var/local/cache/cms
    networks:
      - cms-network
    privileged: true
    cgroup: host
    command: >
      sh -c "wait-for-it database:5432 -t 60 -- cmsLogService ${LOG_SERVICE_SHARD:-0}"
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f cmsLogService && python3 -c \"import socket; s = socket.socket(socket.AF_INET, socket.SOCK_STREAM); s.connect((socket.gethostname(), 29000))\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  # CMS Resource Service - Resource monitoring and management
  resource-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APT_MIRROR: ${APT_MIRROR:-archive.ubuntu.com}
    container_name: cms-resource-service
    restart: unless-stopped
    depends_on:
      database:
        condition: service_healthy
      log-service:
        condition: service_healthy
    environment:
      CMS_CONFIG: ${CMS_CONFIG:-/usr/local/etc/cms.toml}
      SERVICE_TYPE: ResourceService
      SERVICE_SHARD: ${RESOURCE_SERVICE_SHARD:-0}
    ports:
      - "${TAILSCALE_IP:-127.0.0.1}:28000:28000"
    volumes:
      - ./config/cms.toml:/usr/local/etc/cms.toml:ro
      - cms-logs:/var/local/log/cms
      - cms-cache:/var/local/cache/cms
    networks:
      - cms-network
    privileged: true
    cgroup: host
    command: >
      sh -c "sleep 5 && cmsResourceService ${RESOURCE_SERVICE_SHARD:-0}"
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f cmsResourceService && python3 -c \"import socket; s = socket.socket(socket.AF_INET, socket.SOCK_STREAM); s.connect((socket.gethostname(), 28000))\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  # CMS Scoring Service - Handles scoring and ranking
  scoring-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APT_MIRROR: ${APT_MIRROR:-archive.ubuntu.com}
    container_name: cms-scoring-service
    restart: unless-stopped
    depends_on:
      database:
        condition: service_healthy
      log-service:
        condition: service_healthy
    environment:
      CMS_CONFIG: ${CMS_CONFIG:-/usr/local/etc/cms.toml}
      SERVICE_TYPE: ScoringService
      SERVICE_SHARD: ${SCORING_SERVICE_SHARD:-0}
    ports:
      - "${TAILSCALE_IP:-127.0.0.1}:28500:28500"
    volumes:
      - ./config/cms.toml:/usr/local/etc/cms.toml:ro
      - cms-logs:/var/local/log/cms
      - cms-cache:/var/local/cache/cms
      - cms-data:/var/local/lib/cms
    networks:
      - cms-network
    privileged: true
    cgroup: host
    command: >
      sh -c "sleep 5 && cmsScoringService ${SCORING_SERVICE_SHARD:-0}"
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f cmsScoringService && python3 -c \"import socket; s = socket.socket(socket.AF_INET, socket.SOCK_STREAM); s.connect((socket.gethostname(), 28500))\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  # CMS Evaluation Service - Manages evaluation queue
  evaluation-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APT_MIRROR: ${APT_MIRROR:-archive.ubuntu.com}
    container_name: cms-evaluation-service
    restart: unless-stopped
    depends_on:
      database:
        condition: service_healthy
      log-service:
        condition: service_healthy
    environment:
      CMS_CONFIG: ${CMS_CONFIG:-/usr/local/etc/cms.toml}
      SERVICE_TYPE: EvaluationService
      SERVICE_SHARD: ${EVALUATION_SERVICE_SHARD:-0}
      CONTEST_ID: ${CONTEST_ID:-1}
    ports:
      - "${TAILSCALE_IP:-127.0.0.1}:25000:25000"
    volumes:
      - ./config/cms.toml:/usr/local/etc/cms.toml:ro
      - cms-logs:/var/local/log/cms
      - cms-cache:/var/local/cache/cms
      - cms-data:/var/local/lib/cms
    networks:
      - cms-network
    privileged: true
    cgroup: host
    command: >
      sh -c "sleep 5 && cmsEvaluationService ${EVALUATION_SERVICE_SHARD:-0} -c ${CONTEST_ID:-1}"
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f cmsEvaluationService && python3 -c \"import socket; s = socket.socket(socket.AF_INET, socket.SOCK_STREAM); s.connect((socket.gethostname(), 25000))\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  # CMS Proxy Service - Handles communication between services
  proxy-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APT_MIRROR: ${APT_MIRROR:-archive.ubuntu.com}
    container_name: cms-proxy-service
    restart: unless-stopped
    depends_on:
      database:
        condition: service_healthy
      log-service:
        condition: service_healthy
    environment:
      CMS_CONFIG: ${CMS_CONFIG:-/usr/local/etc/cms.toml}
      SERVICE_TYPE: ProxyService
      SERVICE_SHARD: ${PROXY_SERVICE_SHARD:-0}
      CONTEST_ID: ${CONTEST_ID:-1}
    ports:
      - "${TAILSCALE_IP:-127.0.0.1}:28600:28600"
    volumes:
      - ./config/cms.toml:/usr/local/etc/cms.toml:ro
      - cms-logs:/var/local/log/cms
      - cms-cache:/var/local/cache/cms
    networks:
      - cms-network
    privileged: true
    cgroup: host
    command: >
      sh -c "sleep 5 && cmsProxyService ${PROXY_SERVICE_SHARD:-0} -c ${CONTEST_ID:-1}"
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f cmsProxyService && python3 -c \"import socket; s = socket.socket(socket.AF_INET, socket.SOCK_STREAM); s.connect((socket.gethostname(), 28600))\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  # CMS Checker Service - Validates submissions
  checker-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APT_MIRROR: ${APT_MIRROR:-archive.ubuntu.com}
    container_name: cms-checker-service
    restart: unless-stopped
    depends_on:
      database:
        condition: service_healthy
      log-service:
        condition: service_healthy
    environment:
      CMS_CONFIG: ${CMS_CONFIG:-/usr/local/etc/cms.toml}
      SERVICE_TYPE: Checker
      SERVICE_SHARD: ${CHECKER_SERVICE_SHARD:-0}
    ports:
      - "${TAILSCALE_IP:-127.0.0.1}:22000:22000"
    volumes:
      - ./config/cms.toml:/usr/local/etc/cms.toml:ro
      - cms-logs:/var/local/log/cms
      - cms-cache:/var/local/cache/cms
      - cms-data:/var/local/lib/cms
    networks:
      - cms-network
    privileged: true
    cgroup: host
    command: >
      sh -c "sleep 5 && cmsChecker ${CHECKER_SERVICE_SHARD:-0}"
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f cmsChecker && python3 -c \"import socket; s = socket.socket(socket.AF_INET, socket.SOCK_STREAM); s.connect((socket.gethostname(), 22000))\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

networks:
  cms-network:
    name: cms-network
    driver: bridge

volumes:
  cms-database-data:
    name: cms-database-data
  cms-logs:
    name: cms-logs
  cms-cache:
    name: cms-cache
  cms-data:
    name: cms-data