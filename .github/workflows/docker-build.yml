name: Build and Test Docker

on:
  push:
    branches:
      - '**'
    tags:
      - 'v*.*.*'
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            base_image: ubuntu:noble
            tag: amd64
          - platform: linux/arm64
            base_image: debian:bookworm
            tag: arm64
    steps:
      - name: Free disk space
        run: |
          echo "=== Disk space before cleanup ==="
          df -h
          
          echo "=== Removing unnecessary packages ==="
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/share/swift
          
          echo "=== Cleaning Docker ==="
          docker system prune -af || true
          docker volume prune -f || true
          
          echo "=== Disk space after cleanup ==="
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image (${{ matrix.platform }})
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          platforms: ${{ matrix.platform }}
          push: false
          tags: cms-docker:${{ matrix.tag }}
          cache-from: type=gha,scope=${{ matrix.platform }}
          cache-to: type=gha,mode=max,scope=${{ matrix.platform }}
          load: true
          build-args: |
            BASE_IMAGE=${{ matrix.base_image }}
            APT_MIRROR=archive.ubuntu.com

      - name: Verify CMS Import (${{ matrix.platform }})
        if: matrix.platform == 'linux/amd64'
        run: |
          docker run --rm cms-docker:amd64 /bin/bash -c "
            set -x
            echo '=== Import Test ==='
            python3 -c \"import cms; print('CMS imported successfully from:', cms.__file__)\"
          "

  integration-test:
    runs-on: ubuntu-latest
    needs: build
    env:
      POSTGRES_DB: cmsdb
      POSTGRES_USER: cmsuser
      POSTGRES_PASSWORD: ${{ secrets.CMS_POSTGRES_PASSWORD || 'testpassword123' }}
      RANKING_USERNAME: usern4me
      RANKING_PASSWORD: ${{ secrets.CMS_RANKING_PASSWORD || 'passw0rd' }}
      SECRET_KEY: ${{ secrets.CMS_SECRET_KEY || '8e045a51e4b102ea803c06f92841a1fb' }}
    steps:
      - name: Free disk space
        run: |
          echo "=== Disk space before cleanup ==="
          df -h
          
          echo "=== Removing unnecessary packages ==="
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/share/swift
          
          echo "=== Cleaning Docker ==="
          docker system prune -af || true
          docker volume prune -f || true
          
          echo "=== Disk space after cleanup ==="
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image for Integration Test
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64
          push: false
          tags: cms-docker:test
          cache-from: type=gha,scope=linux/amd64
          load: true
          build-args: |
            BASE_IMAGE=ubuntu:noble
            APT_MIRROR=archive.ubuntu.com

      - name: Setup Test Environment
        run: |
          # Create core environment file
          cat > .env.core << EOF
          PUBLIC_IP=0.0.0.0
          APT_MIRROR=archive.ubuntu.com
          POSTGRES_DB=${{ env.POSTGRES_DB }}
          POSTGRES_USER=${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ env.POSTGRES_PASSWORD }}
          POSTGRES_HOST=database
          POSTGRES_HOST_AUTH_METHOD=md5
          CMS_CONFIG=/usr/local/etc/cms.toml
          CMS_LOG_DIR=/var/local/log/cms
          CMS_CACHE_DIR=/var/local/cache/cms
          CMS_DATA_DIR=/var/local/lib/cms
          EOF

          # Create admin environment file
          cat > .env.admin << EOF
          ADMIN_LISTEN_PORT=8889
          ADMIN_LISTEN_ADDRESS=0.0.0.0
          ADMIN_PORT_EXTERNAL=8889
          RANKING_LISTEN_PORT=8890
          RANKING_LISTEN_ADDRESS=0.0.0.0
          RANKING_PORT_EXTERNAL=8890
          RANKING_USERNAME=${{ env.RANKING_USERNAME }}
          RANKING_PASSWORD=${{ env.RANKING_PASSWORD }}
          EOF

          # Create contest environment file
          cat > .env.contest << EOF
          CONTEST_WEB_SERVER_SHARD=0
          CONTEST_LISTEN_PORT=8888
          CONTEST_LISTEN_ADDRESS=0.0.0.0
          CONTEST_PORT_EXTERNAL=8888
          CONTEST_ID=1
          SECRET_KEY=${{ env.SECRET_KEY }}
          EOF

          # Create worker environment file
          cat > .env.worker << EOF
          WORKER_SHARD=0
          EOF

      - name: Setup Config Files
        run: |
          echo "=== Generating configuration using Makefile ==="
          make env
          
          echo "=== Verifying generated config/cms.toml ==="
          grep -i "connection_string =" config/cms.toml || true
          grep -i "secret_key =" config/cms.toml || true

      - name: Upload Config Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cms-config-test
          path: |
            .env*
            config/
          retention-days: 7

      - name: Build Services Sequentially
        run: |
          echo "=== Building services one by one to prevent disk space issues ==="
          
          echo "=== Building log-service ==="
          docker compose -f docker-compose.core.yml build log-service
          docker system prune -f || true
          
          echo "=== Building resource-service ==="
          docker compose -f docker-compose.core.yml build resource-service
          docker system prune -f || true
          
          echo "=== Building scoring-service ==="
          docker compose -f docker-compose.core.yml build scoring-service
          docker system prune -f || true
          
          echo "=== Building checker-service ==="
          docker compose -f docker-compose.core.yml build checker-service
          docker system prune -f || true
          
          echo "=== Building evaluation-service ==="
          docker compose -f docker-compose.core.yml build evaluation-service
          docker system prune -f || true
          
          echo "=== Building proxy-service ==="
          docker compose -f docker-compose.core.yml build proxy-service
          docker system prune -f || true
          
          echo "=== Disk space after sequential builds ==="
          df -h

      - name: Start Core Services
        run: |
          echo "=== Starting Core Services ==="
          docker compose -f docker-compose.core.yml up -d database

          echo "=== Waiting for database to be healthy ==="
          timeout 60 bash -c 'until docker compose -f docker-compose.core.yml ps database | grep -q "healthy"; do sleep 2; echo "Waiting..."; done' || {
            echo "Database health check failed, checking logs..."
            docker compose -f docker-compose.core.yml logs database
            exit 1
          }

          echo "=== Starting remaining core services (already built) ==="
          docker compose -f docker-compose.core.yml up -d --no-build

          echo "=== Waiting for services to start ==="
          sleep 30

          echo "=== Core services status ==="
          docker compose -f docker-compose.core.yml ps

      - name: Initialize Database
        run: |
          echo "=== Initializing CMS Database ==="
          docker exec cms-log-service cmsInitDB || {
            echo "cmsInitDB failed, checking logs..."
            docker logs cms-log-service
            exit 1
          }

          echo "=== Creating test admin user ==="
          docker exec cms-log-service cmsAddAdmin testadmin -p TestPassword123! || {
            echo "cmsAddAdmin failed, checking logs..."
            docker logs cms-log-service
            exit 1
          }

          echo "=== Database initialized successfully ==="

      - name: Build and Start Admin Services
        run: |
          echo "=== Building admin-web-server ==="
          docker compose -f docker-compose.admin.yml build admin-web-server
          docker system prune -f || true
          
          echo "=== Building ranking-web-server ==="
          docker compose -f docker-compose.admin.yml build ranking-web-server
          docker system prune -f || true
          
          echo "=== Starting Admin Services ==="
          docker compose -f docker-compose.admin.yml up -d --no-build

          echo "=== Waiting for admin services to start ==="
          sleep 20

          echo "=== Admin services status ==="
          docker compose -f docker-compose.admin.yml ps

      - name: Verify Admin Web Server
        run: |
          echo "=== Testing Admin Web Server ==="
          timeout 30 bash -c 'until curl -f -s http://localhost:8889/ > /dev/null 2>&1; do sleep 2; echo "Waiting for admin server..."; done' || {
            echo "Admin web server not responding"
            docker logs cms-admin-web-server
            exit 1
          }

          echo "=== Admin Web Server Response ==="
          curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://localhost:8889/

      - name: Build and Start Contest Services
        run: |
          echo "=== Building contest-web-server ==="
          docker compose -f docker-compose.contest.yml build contest-web-server
          docker system prune -f || true
          
          echo "=== Starting Contest Services ==="
          docker compose -f docker-compose.contest.yml up -d --no-build contest-web-server

          echo "=== Waiting for contest services to start ==="
          sleep 20

          echo "=== Contest services status ==="
          docker compose -f docker-compose.contest.yml ps

      - name: Verify Contest Web Server
        run: |
          echo "=== Testing Contest Web Server ==="
          # Contest server may return 403 if no contest is configured, but that's OK
          timeout 30 bash -c 'until curl -s http://localhost:8888/ > /dev/null 2>&1; do sleep 2; echo "Waiting for contest server..."; done' || {
            echo "Warning: Contest web server may not be fully responding (expected if no contest configured)"
          }

          echo "=== Contest Web Server Response ==="
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8888/ || echo "000")
          echo "HTTP Status: $HTTP_CODE"

          # Accept 200, 302 (redirect), 403 (no contest), 500 (service starting)
          if [[ "$HTTP_CODE" =~ ^(200|302|403|500)$ ]]; then
            echo "Contest server is responding (status $HTTP_CODE is acceptable for test)"
          else
            echo "Unexpected status code, checking logs..."
            docker logs cms-contest-web-server-1
          fi

      - name: Build and Start Worker Services
        run: |
          echo "=== Building worker ==="
          docker compose -f docker-compose.worker.yml build worker || true
          docker system prune -f || true

          echo "=== Starting Worker Services ==="
          # Note: Worker may fail in GitHub Actions due to sandbox restrictions
          docker compose -f docker-compose.worker.yml up -d --no-build || true

          echo "=== Waiting for worker to start ==="
          sleep 15

          echo "=== Worker status ==="
          docker compose -f docker-compose.worker.yml ps || true

          echo "=== Worker logs (may show sandbox errors in CI) ==="
          docker logs cms-worker-0 2>&1 | tail -50 || true

      - name: Collect Service Logs
        if: always()
        run: |
          echo "=== All Container Status ==="
          docker ps -a

          echo ""
          echo "=== Log Service Logs ==="
          docker logs cms-log-service 2>&1 | tail -100 || true

          echo ""
          echo "=== Resource Service Logs ==="
          docker logs cms-resource-service 2>&1 | tail -50 || true

          echo ""
          echo "=== Admin Web Server Logs ==="
          docker logs cms-admin-web-server 2>&1 | tail -50 || true

          echo ""
          echo "=== Contest Web Server Logs ==="
          docker logs cms-contest-web-server-1 2>&1 | tail -50 || true

      - name: Cleanup
        if: always()
        run: |
          echo "=== Stopping all services ==="
          docker compose -f docker-compose.worker.yml down -v || true
          docker compose -f docker-compose.contest.yml down -v || true
          docker compose -f docker-compose.admin.yml down -v || true
          docker compose -f docker-compose.core.yml down -v || true

          echo "=== Pruning unused resources ==="
          docker system prune -f || true
