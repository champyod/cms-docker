version: '3.8'

# CMS Contest Stack
# This stack contains the contest web interface for participants
# Requires: Core services stack must be running first
# Configure contest selection via CONTEST_ID environment variable

services:
  # CMS Contest Web Server - Contestant interface
  contest-web-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cms-contest-web-server-${CONTEST_ID:-1}
    restart: unless-stopped
    environment:
      CMS_CONFIG: ${CMS_CONFIG:-/usr/local/etc/cms.conf}
      SERVICE_TYPE: ContestWebServer
      SERVICE_SHARD: ${CONTEST_WEB_SERVER_SHARD:-0}
      CONTEST_LISTEN_PORT: ${CONTEST_LISTEN_PORT:-8888}
      CONTEST_LISTEN_ADDRESS: ${CONTEST_LISTEN_ADDRESS:-0.0.0.0}
      CONTEST_ID: ${CONTEST_ID:-1}
      # Security settings
      SECRET_KEY: ${SECRET_KEY}
      COOKIE_DURATION: ${COOKIE_DURATION:-10800}
      # Submission settings
      MAX_SUBMISSION_LENGTH: ${MAX_SUBMISSION_LENGTH:-100000}
      MAX_INPUT_LENGTH: ${MAX_INPUT_LENGTH:-5000000}
      SUBMIT_LOCAL_COPY: ${SUBMIT_LOCAL_COPY:-true}
      # Number of proxies (nginx, load balancer, etc.)
      NUM_PROXIES_USED: ${NUM_PROXIES_USED:-1}
    volumes:
      - ./config/cms.conf:/usr/local/etc/cms.conf:ro
      - cms-logs:/var/local/log/cms
      - cms-cache:/var/local/cache/cms
      - cms-data:/var/local/lib/cms
      - cms-submissions-${CONTEST_ID:-1}:/var/local/lib/cms/submissions
    networks:
      - cms-network
    ports:
      - "${CONTEST_PORT_EXTERNAL:-8888}:${CONTEST_LISTEN_PORT:-8888}"
    privileged: true
    cgroup: host
    command: >
      sh -c "sleep 10 && cmsContestWebServer ${CONTEST_WEB_SERVER_SHARD:-0} -c ${CONTEST_ID:-1}"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cms-contest-${CONTEST_ID:-1}.rule=Host(`${CONTEST_DOMAIN:-contest.cms.local}`)"
      - "traefik.http.services.cms-contest-${CONTEST_ID:-1}.loadbalancer.server.port=${CONTEST_LISTEN_PORT:-8888}"
      # Optional: Enable HTTPS
      - "traefik.http.routers.cms-contest-${CONTEST_ID:-1}.tls=${ENABLE_TLS:-false}"
      - "traefik.http.routers.cms-contest-${CONTEST_ID:-1}.tls.certresolver=${TLS_CERTRESOLVER:-letsencrypt}"
    deploy:
      resources:
        limits:
          cpus: ${CONTEST_WEB_CPU_LIMIT:-2}
          memory: ${CONTEST_WEB_MEMORY_LIMIT:-2G}
        reservations:
          cpus: ${CONTEST_WEB_CPU_RESERVATION:-0.5}
          memory: ${CONTEST_WEB_MEMORY_RESERVATION:-512M}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${CONTEST_LISTEN_PORT:-8888}/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional: Nginx reverse proxy for contest web server
  nginx-proxy:
    image: nginx:alpine
    container_name: cms-nginx-contest-${CONTEST_ID:-1}
    restart: unless-stopped
    depends_on:
      - contest-web-server
    environment:
      CONTEST_ID: ${CONTEST_ID:-1}
      NGINX_HOST: ${CONTEST_DOMAIN:-contest.cms.local}
      NGINX_PORT: ${NGINX_EXTERNAL_PORT:-80}
    volumes:
      - ./config/nginx-contest.conf:/etc/nginx/templates/default.conf.template:ro
      - nginx-cache:/var/cache/nginx
      - nginx-logs:/var/log/nginx
    networks:
      - cms-network
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    profiles:
      - nginx
    command: >
      sh -c "envsubst '$$NGINX_HOST $$CONTEST_LISTEN_PORT' < /etc/nginx/templates/default.conf.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"

networks:
  cms-network:
    external: true
    name: cms-network

volumes:
  cms-logs:
    external: true
    name: cms-logs
  cms-cache:
    external: true
    name: cms-cache
  cms-data:
    external: true
    name: cms-data
  cms-submissions-1:
    name: cms-submissions-contest-${CONTEST_ID:-1}
  nginx-cache:
    name: cms-nginx-cache-contest-${CONTEST_ID:-1}
  nginx-logs:
    name: cms-nginx-logs-contest-${CONTEST_ID:-1}
