# CMS Admin Stack
# This stack contains the administrative interface for managing contests
# Requires: Core services stack must be running first

services:
  # CMS Admin Panel (Next.js Version)
  admin-panel-next:
    build:
      context: ./admin-panel
      dockerfile: Dockerfile
    image: cms-admin-panel-next
    container_name: cms-admin-panel-next
    restart: unless-stopped
    environment:
      # API and Server Configuration
      VITE_API_URL: ${VITE_API_URL:-http://localhost:8889}
      SERVER_BASE_URL: ${SERVER_BASE_URL:-http://localhost}
      PUBLIC_IP: ${PUBLIC_IP:-0.0.0.0}
      
      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-cmsuser}:${POSTGRES_PASSWORD:-cmspassword}@database:5432/${POSTGRES_DB:-cmsdb}
      
      # Infrastructure Management
      REPO_ROOT: /repo-root
      DEPLOYMENT_TYPE: ${DEPLOYMENT_TYPE:-img}  # 'img' for pre-built images, 'src' for source builds
      IS_DOCKER: "true"
    volumes:
      # Mount Docker socket to allow managing other containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount the root repository to allow editing config/env files on the host
      - ./:/repo-root
      - cms-logs:/var/local/log/cms
    networks:
      - cms-network
    ports:
      - "${ADMIN_NEXT_PORT_EXTERNAL:-8891}:3000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cms-admin-next.rule=Host(`${ADMIN_NEXT_DOMAIN:-admin-next.cms.local}`)"
      - "traefik.http.services.cms-admin-next.loadbalancer.server.port=3000"

  # CMS Admin Web Server (Legacy Python Version)
  admin-web-server:
    build:
      context: .
      dockerfile: Dockerfile
    image: cms-admin-web-server
    container_name: cms-admin-web-server
    restart: unless-stopped
    environment:
      CMS_CONFIG: ${CMS_CONFIG:-/usr/local/etc/cms.toml}
      ADMIN_LISTEN_PORT: ${ADMIN_LISTEN_PORT:-8889}
      ADMIN_LISTEN_ADDRESS: ${ADMIN_LISTEN_ADDRESS:-0.0.0.0}
    volumes:
      - ./config/cms.toml:/usr/local/etc/cms.toml:ro
      - cms-logs:/var/local/log/cms
      - cms-cache:/var/local/cache/cms
    networks:
      - cms-network
    ports:
      - "${ADMIN_PORT_EXTERNAL:-8889}:${ADMIN_LISTEN_PORT:-8889}"
    command: >
      sh -c "sleep 10 && cmsAdminWebServer"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cms-admin.rule=Host(`${ADMIN_DOMAIN:-admin.cms.local}`)"
      - "traefik.http.services.cms-admin.loadbalancer.server.port=${ADMIN_LISTEN_PORT:-8889}"

  # Ranking Web Server - Live rankings display
  ranking-web-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cms-ranking-web-server
    restart: unless-stopped
    environment:
      CMS_RANKING_CONFIG: ${CMS_RANKING_CONFIG:-/usr/local/etc/cms_ranking.toml}
      RANKING_LISTEN_PORT: ${RANKING_LISTEN_PORT:-8890}
      RANKING_LISTEN_ADDRESS: ${RANKING_LISTEN_ADDRESS:-0.0.0.0}
    volumes:
      - ./config/cms_ranking.toml:/usr/local/etc/cms_ranking.toml:ro
      - cms-logs:/var/local/log/cms
      - cms-ranking-data:/var/local/lib/cms/ranking
    networks:
      - cms-network
    ports:
      - "${RANKING_PORT_EXTERNAL:-8890}:${RANKING_LISTEN_PORT:-8890}"
    command: >
      sh -c "sleep 10 && cmsRankingWebServer"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cms-ranking.rule=Host(`${RANKING_DOMAIN:-ranking.cms.local}`)"
      - "traefik.http.services.cms-ranking.loadbalancer.server.port=${RANKING_LISTEN_PORT:-8890}"

  # Printing Service - Manages printing requests (optional)
  printing-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cms-printing-service
    restart: unless-stopped
    environment:
      CMS_CONFIG: ${CMS_CONFIG:-/usr/local/etc/cms.toml}
      SERVICE_TYPE: PrintingService
      SERVICE_SHARD: ${PRINTING_SERVICE_SHARD:-0}
      PRINTING_ENABLED: ${PRINTING_ENABLED:-false}
    volumes:
      - ./config/cms.toml:/usr/local/etc/cms.toml:ro
      - cms-logs:/var/local/log/cms
      - cms-cache:/var/local/cache/cms
    networks:
      - cms-network
    privileged: true
    cgroup: host
    profiles:
      - printing
    command: >
      sh -c "if [ \"$PRINTING_ENABLED\" = \"true\" ]; then sleep 10 && cmsPrintingService ${PRINTING_SERVICE_SHARD:-0}; else echo 'Printing service disabled'; sleep infinity; fi"

networks:
  cms-network:
    external: true
    name: cms-network

volumes:
  cms-logs:
    external: true
    name: cms-logs
  cms-cache:
    external: true
    name: cms-cache
  cms-data:
    external: true
    name: cms-data
  cms-ranking-data:
    name: cms-ranking-data
