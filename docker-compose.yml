# Contest Management System (CMS) - Docker Compose Configuration
# Professional Docker deployment solution created by CCYod
# Repository: https://github.com/champyod/cms-docker
# 
# This configuration provides a complete CMS deployment with:
# - PostgreSQL database with proper CMS permissions
# - CMS core services (Contest, Admin, Evaluation, Workers)
# - CMS ranking service (Scoreboard)
# - Nginx reverse proxy (optional, for domain routing)
# - Health checks and persistent volumes
# - Support for Raspberry Pi distributed workers

version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    build:
      context: .
      dockerfile: docker/postgres/Dockerfile
    container_name: cms-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-cmsdb}
      POSTGRES_USER: ${POSTGRES_USER:-cmsuser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PUBLIC_PORT:-5432}:5432"
    networks:
      - cms-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-cmsuser} -d $${POSTGRES_DB:-cmsdb}"]
      interval: 30s
      timeout: 10s
      retries: 5

  # CMS Core Services
  cms-core:
    build: .
    container_name: cms-core
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database Configuration
      CMS_DB_HOST: postgres
      CMS_DB_PORT: 5432
      CMS_DB_NAME: ${POSTGRES_DB:-cmsdb}
      CMS_DB_USER: ${POSTGRES_USER:-cmsuser}
      CMS_DB_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      
      # Web Server Configuration
      CMS_SECRET_KEY: ${CMS_SECRET_KEY:-8e045a51e4b102ea803c06f92841a1fb}
      CMS_TORNADO_DEBUG: ${CMS_TORNADO_DEBUG:-false}
      
      # Contest Web Server
      CMS_CONTEST_LISTEN_ADDRESS: ${CMS_CONTEST_LISTEN_ADDRESS:-0.0.0.0}
      CMS_CONTEST_LISTEN_PORT: ${CMS_CONTEST_LISTEN_PORT:-8888}
      CMS_CONTEST_COOKIE_DURATION: ${CMS_CONTEST_COOKIE_DURATION:-10800}
      
      # Admin Web Server
      CMS_ADMIN_LISTEN_ADDRESS: ${CMS_ADMIN_LISTEN_ADDRESS:-0.0.0.0}
      CMS_ADMIN_LISTEN_PORT: ${CMS_ADMIN_LISTEN_PORT:-8889}
      CMS_ADMIN_COOKIE_DURATION: ${CMS_ADMIN_COOKIE_DURATION:-36000}
      
      # Ranking Configuration
      CMS_RANKING_USERNAME: ${CMS_RANKING_USERNAME:-admin}
      CMS_RANKING_PASSWORD: ${CMS_RANKING_PASSWORD:-changeme}
      
      # Storage Paths
      CMS_LOG_DIR: ${CMS_LOG_DIR:-/opt/cms/log}
      CMS_CACHE_DIR: ${CMS_CACHE_DIR:-/opt/cms/cache}
      CMS_DATA_DIR: ${CMS_DATA_DIR:-/opt/cms/lib}
      CMS_RUN_DIR: ${CMS_RUN_DIR:-/opt/cms/run}
      
      # Service Configuration
      CMS_NUM_WORKERS: ${CMS_NUM_WORKERS:-4}
      CMS_MAX_SUBMISSION_LENGTH: ${CMS_MAX_SUBMISSION_LENGTH:-100000}
      CMS_MAX_INPUT_LENGTH: ${CMS_MAX_INPUT_LENGTH:-5000000}
      
      # Contest Configuration
      CMS_CONTEST_ID: ${CMS_CONTEST_ID:-null}
      CMS_AUTO_CREATE_CONTEST: ${CMS_AUTO_CREATE_CONTEST:-true}
      CMS_CONTEST_NAME: ${CMS_CONTEST_NAME:-Sample Programming Contest}
      CMS_CONTEST_DESCRIPTION: ${CMS_CONTEST_DESCRIPTION:-A sample contest for testing CMS deployment}
      CMS_CONTEST_START_TIME: ${CMS_CONTEST_START_TIME:-2024-01-01T00:00:00}
      CMS_CONTEST_END_TIME: ${CMS_CONTEST_END_TIME:-2024-12-31T23:59:59}
      CMS_CONTEST_TIMEZONE: ${CMS_CONTEST_TIMEZONE:-UTC}
      CMS_CONTEST_LANGUAGES: ${CMS_CONTEST_LANGUAGES:-["C++17 / g++", "C11 / gcc", "Python 3 / CPython", "Java / JDK"]}
      
      # Contest Token System
      CMS_CONTEST_TOKEN_MODE: ${CMS_CONTEST_TOKEN_MODE:-finite}
      CMS_CONTEST_TOKEN_MAX: ${CMS_CONTEST_TOKEN_MAX:-100}
      CMS_CONTEST_TOKEN_MIN_INTERVAL: ${CMS_CONTEST_TOKEN_MIN_INTERVAL:-60}
      CMS_CONTEST_TOKEN_INITIAL: ${CMS_CONTEST_TOKEN_INITIAL:-2}
      CMS_CONTEST_TOKEN_GEN_NUMBER: ${CMS_CONTEST_TOKEN_GEN_NUMBER:-1}
      CMS_CONTEST_TOKEN_GEN_INTERVAL: ${CMS_CONTEST_TOKEN_GEN_INTERVAL:-600}
      
      # Contest Limits
      CMS_CONTEST_MAX_SUBMISSIONS: ${CMS_CONTEST_MAX_SUBMISSIONS:-100}
      CMS_CONTEST_MAX_USER_TESTS: ${CMS_CONTEST_MAX_USER_TESTS:-100}
      CMS_CONTEST_SCORE_PRECISION: ${CMS_CONTEST_SCORE_PRECISION:-2}
      
      # Advanced Configuration
      CMS_NUM_PROXIES: ${CMS_NUM_PROXIES:-1}
      CMS_SUBMIT_LOCAL_COPY: ${CMS_SUBMIT_LOCAL_COPY:-true}
      CMS_TESTS_LOCAL_COPY: ${CMS_TESTS_LOCAL_COPY:-true}
      CMS_DOCS_PATH: ${CMS_DOCS_PATH:-/usr/share/cms/docs}
      
      # Sandbox Configuration
      CMS_KEEP_SANDBOX: ${CMS_KEEP_SANDBOX:-false}
      CMS_SANDBOX_MAX_FILE_SIZE: ${CMS_SANDBOX_MAX_FILE_SIZE:-1048576}
      CMS_COMPILATION_MAX_PROCESSES: ${CMS_COMPILATION_MAX_PROCESSES:-1000}
      CMS_COMPILATION_MAX_TIME: ${CMS_COMPILATION_MAX_TIME:-10.0}
      CMS_COMPILATION_MAX_MEMORY: ${CMS_COMPILATION_MAX_MEMORY:-524288}
      CMS_TRUSTED_MAX_PROCESSES: ${CMS_TRUSTED_MAX_PROCESSES:-1000}
      CMS_TRUSTED_MAX_TIME: ${CMS_TRUSTED_MAX_TIME:-10.0}
      CMS_TRUSTED_MAX_MEMORY: ${CMS_TRUSTED_MAX_MEMORY:-4194304}
      
      # Printing Configuration
      CMS_PRINT_MAX_LENGTH: ${CMS_PRINT_MAX_LENGTH:-10000000}
      CMS_PRINT_PAPER_SIZE: ${CMS_PRINT_PAPER_SIZE:-A4}
      CMS_PRINT_MAX_PAGES: ${CMS_PRINT_MAX_PAGES:-10}
      CMS_PRINT_MAX_JOBS: ${CMS_PRINT_MAX_JOBS:-10}
      CMS_PRINT_PDF_ALLOWED: ${CMS_PRINT_PDF_ALLOWED:-false}
      
      # Monitoring Configuration
      CMS_PROMETHEUS_ADDRESS: ${CMS_PROMETHEUS_ADDRESS:-0.0.0.0}
      CMS_PROMETHEUS_PORT: ${CMS_PROMETHEUS_PORT:-8811}
      
      # Telegram Bot Configuration (Optional)
      CMS_TELEGRAM_ENABLED: ${CMS_TELEGRAM_ENABLED:-false}
      CMS_TELEGRAM_BOT_TOKEN: ${CMS_TELEGRAM_BOT_TOKEN:-}
      CMS_TELEGRAM_CHAT_ID: ${CMS_TELEGRAM_CHAT_ID:-}
    volumes:
      - cms_log:/opt/cms/log
      - cms_cache:/opt/cms/cache
      - cms_data:/opt/cms/lib
      - cms_run:/opt/cms/run
      - contest_data:/opt/cms/contests
      - ./config:/opt/cms/config:ro
    ports:
      - "${CMS_CONTEST_PUBLIC_PORT:-8888}:8888"   # Contest Web Server
      - "${CMS_ADMIN_PUBLIC_PORT:-8889}:8889"     # Admin Web Server
      - "${CMS_LOG_SERVICE_PORT:-29000}:29000"    # LogService (for external workers)
      - "${CMS_RESOURCE_SERVICE_PORT:-28000}:28000" # ResourceService
      - "${CMS_SCORING_SERVICE_PORT:-28500}:28500"  # ScoringService
      - "${CMS_EVALUATION_SERVICE_PORT:-25000}:25000" # EvaluationService
      - "${CMS_PROXY_SERVICE_PORT:-28600}:28600"    # ProxyService
    networks:
      - cms-network
    command: /opt/cms/scripts/start-cms.sh
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # CMS Ranking Server
  cms-ranking:
    build: .
    container_name: cms-ranking
    restart: unless-stopped
    depends_on:
      - cms-core
    environment:
      # Ranking Server Configuration
      CMS_RANKING_BIND_ADDRESS: ${CMS_RANKING_BIND_ADDRESS:-0.0.0.0}
      CMS_RANKING_HTTP_PORT: ${CMS_RANKING_HTTP_PORT:-8890}
      CMS_RANKING_USERNAME: ${CMS_RANKING_USERNAME:-admin}
      CMS_RANKING_PASSWORD: ${CMS_RANKING_PASSWORD:-changeme}
      CMS_RANKING_REALM: ${CMS_RANKING_REALM:-Scoreboard}
      CMS_RANKING_BUFFER_SIZE: ${CMS_RANKING_BUFFER_SIZE:-100}
      
      # Storage
      CMS_RANKING_LOG_DIR: ${CMS_RANKING_LOG_DIR:-/opt/cms/log/ranking}
      CMS_RANKING_LIB_DIR: ${CMS_RANKING_LIB_DIR:-/opt/cms/lib/ranking}
    volumes:
      - cms_ranking_log:/opt/cms/log/ranking
      - cms_ranking_lib:/opt/cms/lib/ranking
      - ./config:/opt/cms/config:ro
    ports:
      - "${CMS_RANKING_PUBLIC_PORT:-8890}:8890"
    networks:
      - cms-network
    command: /opt/cms/scripts/start-ranking.sh
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8890/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx Reverse Proxy (Optional - disable if using direct ports)
  nginx:
    image: nginx:alpine
    container_name: cms-nginx
    restart: unless-stopped
    depends_on:
      - cms-core
      - cms-ranking
    environment:
      CMS_DOMAIN: ${CMS_DOMAIN:-localhost}
      USE_NGINX: ${USE_NGINX:-false}
    volumes:
      - ./nginx/nginx.conf.template:/etc/nginx/templates/default.conf.template:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    networks:
      - cms-network
    profiles:
      - nginx  # Only start nginx when specifically requested

volumes:
  postgres_data:
    driver: local
  cms_log:
    driver: local
  cms_cache:
    driver: local
  cms_data:
    driver: local
  cms_run:
    driver: local
  cms_ranking_log:
    driver: local
  cms_ranking_lib:
    driver: local
  contest_data:
    driver: local

networks:
  cms-network:
    driver: bridge
