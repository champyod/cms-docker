services:
  monitor:
    build:
      context: .
      dockerfile: docker/monitor/Dockerfile
    image: cms-monitor
    container_name: cms-monitor
    restart: on-failure:5
    pid: host   # Required to see Host CPU/Memory usage
    environment:
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - DISCORD_ROLE_ID=${DISCORD_ROLE_ID}
      - MONITOR_INTERVAL=5
      - MONITOR_COOLDOWN=300
      - DISK_PATH=/host
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@database:5432/${POSTGRES_DB}
      - BACKUP_INTERVAL_MINS=${BACKUP_INTERVAL_MINS:-1440}
      - BACKUP_MAX_COUNT=${BACKUP_MAX_COUNT:-50}
      - BACKUP_MAX_AGE_DAYS=${BACKUP_MAX_AGE_DAYS:-10}
      - BACKUP_MAX_SIZE_GB=${BACKUP_MAX_SIZE_GB:-5}
      - BACKUP_DIR=/app/backups
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /:/host:ro # Mount host root to /host to check disk usage
      - ./backups:/app/backups
      - ./scripts/cms-backup.sh:/usr/local/bin/cms-backup.sh:ro
      - ./config:/repo-root/config:ro # Mount config to read container restart settings
    networks:
      - cms-network

networks:
  cms-network:
    external: true
    name: cms-network
